name: Poetry CI Workflow

on:
  push:
    branches:
      - master

jobs:
  install_dependencies:
    runs-on: ubuntu-latest
    steps:
      # Checkout the code
      - name: Checkout code
        uses: actions/checkout@v3
        
      # Cache Poetry cache directory
      - name: Cache Poetry cache
        uses: actions/cache@v3
        with:
          path: ~/.cache/pypoetry
          key: ${{ runner.os }}-poetry-cache-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-poetry-cache-
          
      # Install Poetry using pip
      - name: Install Poetry
        run: |
          pip install poetry
          echo "Poetry installed at:"
          which poetry
          poetry --version

      # Install dependencies using Poetry
      - name: Install dependencies with Poetry
        run: poetry install --no-root

      # Cache Python dependencies
      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.local  # Cache Python packages installed by Poetry
          key: ${{ runner.os }}-poetry-dependencies-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-poetry-dependencies-

      # Cache Poetry binary to reuse it in the next job
      - name: Cache Poetry binary
        uses: actions/cache@v3
        with:
          path: ~/.local/bin/poetry
          key: ${{ runner.os }}-poetry-bin-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-poetry-bin-

  use_poetry_cache:
    needs: install_dependencies  # This makes sure this job runs after the previous one
    runs-on: ubuntu-latest
    steps:
      # Checkout the code
      - name: Checkout code
        uses: actions/checkout@v3

      # Restore Poetry binary cache
      - name: Restore Poetry binary cache
        uses: actions/cache@v3
        with:
          path: ~/.local/bin/poetry
          key: ${{ runner.os }}-poetry-bin-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-poetry-bin-

      # Restore Poetry cache
      - name: Restore Poetry cache
        uses: actions/cache@v3
        with:
          path: ~/.cache/pypoetry
          key: ${{ runner.os }}-poetry-cache-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-poetry-cache-

      # Restore Python dependencies cache
      - name: Restore Python dependencies cache
        uses: actions/cache@v3
        with:
          path: ~/.local
          key: ${{ runner.os }}-poetry-dependencies-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-poetry-dependencies-

      # Check Poetry version (Poetry should now be available)
      - name: Check Poetry version
        run: poetry --version

      # Example of running your code (tests)
      - name: Running the tests
        run: echo "Running tests..."  # Replace with your actual test command
      - name: running the script
        run: echo "printing the code"
